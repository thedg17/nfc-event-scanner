<!DOCTYPE html>
<html>
<head>
    <title>Register NFC Card</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google OAuth + Sheets -->
    <script src="config.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://apis.google.com/js/platform.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; }
        input { padding: 10px; width: 100%; margin-bottom: 10px; }
        button { padding: 12px; width: 100%; font-size: 18px; margin-top: 10px; }
    </style>
</head>

<body>
<h2>Register NFC Card</h2>

<label>Participant Name:</label>
<input id="name" placeholder="Enter name">

<label>Card ID (IDEA0001):</label>
<input id="cardid" placeholder="IDEA0001" value="IDEA0001">

<button id="writeButton">Write to NFC Tag</button>

<p id="status"></p>

<script>
// =====================
// GOOGLE SHEETS SETUP
// =====================
function initClient() {
    gapi.client
        .init({
            apiKey: AIzaSyDjeOD1iJJ16hDIG0_gLBpPCTmqzW0KxAk,
            clientId: 813185029300-ej2m0qrpae9kucc0b2b89phu1l2poc7u.apps.googleusercontent.com,
            scope: https://www.googleapis.com/auth/spreadsheets,
            discoveryDocs: [
                "https://sheets.googleapis.com/$discovery/rest?version=v4"
            ],
        })
        .then(() => console.log("Google API Ready"));
}

gapi.load("client:auth2", initClient);

// Append row to Google Sheet
async function appendRegisterRow(name, cardid) {
    return gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: /d/1Vp3kqDAZNHwYD-AHiYjM5ry646Bd6J5GhKFUe71J7hA/edit?gid=1843599820#gid=1843599820,
        range: "Register!A:C",
        valueInputOption: "RAW",
        insertDataOption: "INSERT_ROWS",
        resource: {
            values: [[CardID, ParticipantName, new Date().toLocaleString()]]
        }
    });
}

// =====================
// NFC WRITE FUNCTION
// =====================
document.getElementById("writeButton").addEventListener("click", async () => {
    const name = document.getElementById("name").value.trim();
    const cardid = document.getElementById("cardid").value.trim();

    if (!name || !cardid) {
        alert("Enter name and Card ID");
        return;
    }

    try {
        const ndef = new NDEFReader();

        await ndef.write({
            records: [
                {
                    recordType: "text",
                    data: cardid
                }
            ]
        });

        alert("Card written successfully!");

        // Save in Google Sheet
        await appendRegisterRow(name, cardid);

        alert("Saved to Google Sheet!");

    } catch (error) {
        alert("NFC Write Error: " + JSON.stringify(error));
        console.error(error);
    }
});
</script>

</body>
</html>

