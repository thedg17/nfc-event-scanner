<!DOCTYPE html>
<html>
<head>
    <title>Register NFC Card</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="config.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://apis.google.com/js/platform.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; }
        input { padding: 10px; width: 100%; margin-bottom: 10px; }
        button { padding: 12px; width: 100%; font-size: 18px; margin-top: 10px; }
    </style>
</head>

<body>
<h2>Register NFC Card</h2>

<label>Participant Name:</label>
<input id="name" placeholder="Enter name">

<label>Card ID (IDEA0001):</label>
<input id="cardid" placeholder="IDEA0001" value="IDEA0001">

<button onclick="writeToCard()">Write to NFC Tag</button>

<p id="status"></p>

<script>
function initClient() {
    gapi.client
        .init({
            apiKey: GOOGLE_API_KEY,
            clientId: GOOGLE_CLIENT_ID,
            scope: SCOPES,
            discoveryDocs: [
                "https://sheets.googleapis.com/$discovery/rest?version=v4"
            ],
        })
        .then(() => console.log("Google API Ready"));
}

gapi.load("client:auth2", initClient);

async function writeToCard() {
    const name = document.getElementById("name").value.trim();
    const cardid = document.getElementById("cardid").value.trim();

    if (!name || !cardid) {
        alert("Enter name and CardID");
        return;
    }

    try {
        const ndef = new NDEFReader();
        await ndef.write({
    records: [
        {
            recordType: "text",
            data: cardId
        }
    ]
});

        document.getElementById("status").innerText =
            "✔ Card written successfully! Saving to Google Sheet…";

        await saveToGoogleSheet(cardid, name);

        document.getElementById("status").innerText =
            "✔ Registration complete!";
    } catch (err) {
        alert("NFC Write Error: " + err);
    }
}

async function saveToGoogleSheet(cardid, name) {
    const now = new Date().toLocaleString();

    return gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SHEET_ID,
        range: "Sheet1!A:E",
        valueInputOption: "RAW",
        insertDataOption: "INSERT_ROWS",
        resource: {
            values: [[now, cardid, name, "REGISTER", "REG DEVICE"]],
        },
    });
}
</script>

</body>
</html>
