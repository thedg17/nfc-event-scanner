<!DOCTYPE html>
<html>
<head>
    <title>Scan Event Entry</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google OAuth + Sheets -->
    <script src="config.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; }
        label { display: block; margin-top: 15px; }
        select, input { padding: 10px; width: 100%; margin-top: 5px; }
        button { padding: 14px; width: 100%; margin-top: 20px; font-size: 18px; }
        #log { margin-top: 20px; padding: 10px; background: #eee; }
    </style>
</head>

<body>

<h2>Event NFC Scanner</h2>

<label>Scanner Name:</label>
<input id="scannerName" placeholder="Eg: Gate A Staff">

<label>Select Event:</label>
<select id="eventSelect">
    <option value="Event 1">Event 1</option>
    <option value="Event 2">Event 2</option>
    <option value="Event 3">Event 3</option>
    <option value="Event 4">Event 4</option>
    <option value="Event 5">Event 5</option>
</select>

<button id="scanButton">Scan NFC Tag</button>

<div id="log"></div>

<script>
// =========================
// Google API Init
// =========================
function initClient() {
    gapi.client.init({
        apiKey: AIzaSyDjeOD1iJJ16hDIG0_gLBpPCTmqzW0KxAk,
        clientId: 813185029300-ej2m0qrpae9kucc0b2b89phu1l2poc7u.apps.googleusercontent.com,
        scope: https://www.googleapis.com/auth/spreadsheets,
        discoveryDocs: [
            "https://sheets.googleapis.com/$discovery/rest?version=v4"
        ],
    })
    .then(() => console.log("Google API Ready"));
}

gapi.load("client:auth2", initClient);

// =========================
// Append Scan Log to Sheet
// =========================
async function appendScanRow(CardID, Name, Event, Scanner, Timestamp) {
    return gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: 1Vp3kqDAZNHwYD-AHiYjM5ry646Bd6J5GhKFUe71J7h,
        range: "Scans!A:E",
        valueInputOption: "RAW",
        insertDataOption: "INSERT_ROWS",
        resource: {
            values: [[
                cardid,
                name,
                eventName,
                scannerName,
                new Date().toLocaleString()
            ]]
        }
    });
}

// =========================
// Fetch Name from Register Sheet
// =========================
async function getNameFromSheet(cardid) {
    const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SHEET_ID,
        range: "Register!A:B"
    });

    const rows = response.result.values || [];

    for (let row of rows) {
        if (row[1] === cardid) return row[0]; // row = [name, cardid]
    }

    return "Unknown";
}

// =========================
// START SCAN
// =========================
document.getElementById("scanButton").addEventListener("click", async () => {
    const eventName = document.getElementById("eventSelect").value;
    const scannerName = document.getElementById("scannerName").value.trim();

    if (!scannerName) {
        alert("Enter Scanner Name first");
        return;
    }

    try {
        const ndef = new NDEFReader();
        await ndef.scan();

        document.getElementById("log").innerHTML = "Hold NFC card near device...";

        ndef.addEventListener("reading", async ({ message }) => {
            let cardid = "";

            const record = message.records[0];
            if (record.recordType === "text") {
                const textDecoder = new TextDecoder();
                cardid = textDecoder.decode(record.data);
            }

            const name = await getNameFromSheet(cardid);

            await appendScanRow(cardid, name, eventName, scannerName);

            document.getElementById("log").innerHTML =
                `Scanned:<br>
                <b>Card ID:</b> ${cardid}<br>
                <b>Name:</b> ${name}<br>
                <b>Event:</b> ${eventName}<br>
                <b>Scanner:</b> ${scannerName}<br>
                <b>Time:</b> ${new Date().toLocaleString()}`;
        });

    } catch (err) {
        alert("NFC Scan Error: " + JSON.stringify(err));
        console.error(err);
    }
});
</script>

</body>
</html>

